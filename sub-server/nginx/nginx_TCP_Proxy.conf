# /nginx/nginx_TCP_Proxy.conf
# Nginx의 메인 설정 파일 템플릿

user  nginx;
worker_processes  auto;
pid /var/run/nginx.pid;

events {
    worker_connections  1024;
}

# --- 1. (핵심) TCP 프록시 (SSL Passthrough) ---
# http 블록과 동일한 레벨(최상위)에 stream 블록을 정의
stream {
    server {
        # 443 포트로 들어오는 TCP 연결을 수신
        listen 443;

        # SubServer (공유기)의 IP와 포트로 그대로 전달
        # (예: 123.45.67.89:8888)
        proxy_pass [공유기_공인_IP]:[포트];

        # --- (중요) 원본 IP 보존을 위한 PROXY Protocol ---
        # 이 옵션을 켜면, Nginx가 SubServer로 연결할 때
        # 원본 클라이언트 IP 정보를 "꼬리표"로 붙여 보냅니다.
        proxy_protocol on;
    }
}


# --- 2. (보조) HTTP 서버 (Certbot용) ---
# 80 포트는 Certbot 인증서 갱신을 위해 HTTP 모드로 유지합니다.
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Certbot을 위한 80 포트 설정
    # (이 부분은 기존 nginx-init.conf 또는 nginx-ssl.conf의 80포트 내용을
    #  /nginx/conf.d/default.conf 같은 파일로 분리해서 관리)
    include /etc/nginx/conf.d/*.conf; 
}