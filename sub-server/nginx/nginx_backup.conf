# nginx_target.conf (최초 인증용 - 400 오류 해결 버전)

# Nginx 실행에 필요한 기본 설정
worker_processes  auto;
pid /var/run/nginx.pid;

events {
    worker_connections  1024;
}

# (stream 블록 없음)

# --- HTTP (Certbot 최초 인증용) ---
http {
    # --- [핵심 해결] 400 오류 방지 ---
    # 4개의 긴 도메인 이름을 처리할 메모리 공간 확보
    server_names_hash_bucket_size 64; 
    # -----------------------------------

    server {
        listen 80;
        server_name jenkins.paulryu93.ddns.net;

        # Certbot 인증 경로
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # 인증 외 요청은 404 반환
        location / {
            proxy_pass http://jenkins-server:8080; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    server {
        listen 80;
        server_name admin.paulryu93.ddns.net;

        # Certbot 인증 경로
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # 인증 외 요청은 404 반환
        location / {
            return 404;
        }
    }

    server {
        listen 80;
        server_name n8n.paulryu93.ddns.net;

        # Certbot 인증 경로
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # 인증 외 요청은 404 반환
        location / {
            proxy_pass http://n8n-server:5678;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    server {
        listen 80;
        server_name storage.paulryu93.ddns.net;

        # Certbot 인증 경로
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # 인증 외 요청은 404 반환
        location / {
            return 404;
        }
    }
}