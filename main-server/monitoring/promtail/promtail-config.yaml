server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  # [핵심] Loki 서버의 주소입니다. Sub Server (Centre)의 내부 IP를 사용해야 합니다.
  # Sub Server의 Loki는 3100 포트로 외부에 노출되어 있어야 합니다.
  - url: http://192.168.0.41:3100/loki/api/v1/push

scrape_configs:
  # --- 1. Docker 컨테이너 로그 수집 ---
  - job_name: containers
    # --- Docker Service Discovery with Labeling ---
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    
    relabel_configs:
      # 1. 컨테이너 이름 추출 (/main-nestjs-blue -> main-nestjs-blue)
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container_name'
      
      # 2. 로그 스트림 (stdout/stderr) 추출
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'

      # 3. 고정 라벨 추가
      - target_label: 'host'
        replacement: 'protostar-main'
      - target_label: 'environment'
        replacement: 'production'

  # --- 2. 시스템 로그 수집 (선택적) ---
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          __path__: /var/log/syslog  # 우분투 기본 시스템 로그 경로
          job: system-syslog
          host: protostar-main